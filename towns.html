<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Town Dashboard - GDD GD</title>

  <!-- AdminLTE & FontAwesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    #map { height: 500px; width: 100%; }
    #villageAttributes { width: 100%; border-collapse: collapse; }
    #villageAttributes th, #villageAttributes td { border: 1px solid #ccc; padding: 5px; }
    #villageAttributes th { background-color: #f0f0f0; width: 40%; }
    .row-flex { display: flex; flex-wrap: wrap; gap: 20px; }
    .col-map { flex: 2 1 60%; min-width: 300px; }
    .col-table { flex: 1 1 35%; min-width: 250px; }
    @media (max-width: 768px) { .row-flex { flex-direction: column; } }

    .top-navbar-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1050;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      background: #fff;
    }
    @media (max-width: 767.98px) {
      body, .content-wrapper {
        padding-top: 55px !important;
      }
      .main-header .navbar-nav .nav-item img {
        height: 32px !important;
        margin-right: 6px !important;
      }
      .main-header .navbar-nav .nav-item div span {
        font-size: 0.95rem !important;
      }
    }
    @media (min-width: 768px) {
      body, .content-wrapper {
        padding-top: 65px !important;
      }
    }
    /* Hide sidebar on mobile, show toggle button */
    @media (max-width: 991.98px) {
      .main-sidebar {
        left: -250px;
        transition: left 0.3s;
      }
      .main-sidebar.active {
        left: 0;
      }
      #sidebarToggle {
        display: block !important;
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 3000;           /* Highest z-index to stay on top */
        width: 56px;             /* Larger clickable area */
        height: 56px;
        padding: 0;
        background: transparent;  /* Transparent background */
        border: none;
        box-shadow: none;
        color: #007bff;
        border-radius: 50%;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #sidebarToggle i {
        font-size: 2rem;
        pointer-events: none;    /* Ensures the button itself gets the click */
      }
      .sidebar-backdrop {
        display: none;
        position: fixed;
        z-index: 1049;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.3);
      }
      .sidebar-backdrop.active {
        display: block;
      }
    }
    @media (min-width: 992px) {
      #sidebarToggle, .sidebar-backdrop {
        display: none !important;
      }
    }
    .main-sidebar {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    .main-sidebar .brand-link {
      position: sticky;
      top: 0;
      z-index: 1100;
      margin-top: 0 !important;
      padding-top: 0.5rem !important;
      padding-bottom: 0.5rem !important;
      height: 65px !important;
      min-height: 65px !important;
      box-sizing: border-box;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<button id="sidebarToggle" class="btn btn-primary" style="position:fixed;top:12px;left:12px;z-index:2001;display:none;">
  <i class="fas fa-bars"></i>
</button>
<div class="sidebar-backdrop"></div>
<div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(255,255,255,0.8);display:flex;align-items:center;justify-content:center;">
  <div>
    <i class="fas fa-spinner fa-spin fa-3x" style="color:#007bff;"></i>
    <div style="margin-top:10px;text-align:center;color:#007bff;font-weight:bold;">Loading...</div>
  </div>
</div>
<div class="wrapper">

  <!-- Navbar (same as index.html) -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light top-navbar-fixed" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="d-flex align-items-center">
      <img src="soi.png" alt="SOI Logo" style="height: 40px; width: auto; margin-right: 10px;">
      <div style="display: flex; flex-direction: column; line-height: 1;">
        <span style="font-weight: bold; font-size: 1.1rem; color: #0056b3;">GUJARAT DAMAN &amp; DIU GD</span>
        <span style="font-size: 0.95rem; color: #e85a8b; font-weight: bold;">AMRUT 2.0</span>
      </div>
    </div>
    <div class="d-flex align-items-center">
      <img src="amrut-logo.png" alt="Top Logo" style="height: 60px; width: auto; margin-left: 10px;">
    </div>
  </nav>

  <!-- Sidebar (same as index.html) -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link d-flex align-items-center p-2 sidebar-header-rose"
       style="width:100%; background: #0056b3; color: #fff; box-sizing: border-box; height: 65px; min-height: 65px;">
      <img src="soi.png" alt="Logo" style="width: 45px; height: auto; margin-right: 10px;">
      <div>
        <span class="brand-text font-weight-bold" style="font-size: 1.2rem; color: #fff;">SOI</span>
      </div>
    </a>
    <div class="sidebar">
      <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
        <li class="nav-item">
          <a href="index.html" class="nav-link">
            <i class="nav-icon fas fa-home text-success"></i>
            <p><strong>Home</strong></p>
          </a>
        </li>
        <li class="nav-item">
          <a href="towns.html" class="nav-link active">
            <i class="nav-icon fas fa-map-marker-alt text-info animate__animated animate__pulse animate__infinite"></i>
            <p><strong>Town</strong></p>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <!-- Content -->
  <div class="content-wrapper p-3">
    <section class="content">
      <div class="container-fluid">

        <!-- Select Dropdown in Main Body -->
        <div class="row mb-3">
          <div class="col-md-4 col-sm-8 col-12">
            <label for="townSelect" class="font-weight-bold mb-1">Select Town</label>
            <select id="townSelect" class="form-control mb-2">
              <option value="">-- Select Town --</option>
            </select>
          </div>
        </div>

        <div class="row-flex">
          <div class="col-map">
            <div id="map"></div>
          </div>
          <div class="col-table">
            <div id="sideTownTitle" style="text-align: center; background-color: #f3e5f5; padding: 8px; font-weight: bold; color: #6a1b9a; display: none;"></div>
            <div id="villageDetails"></div>
            <div id="sheetDetails" class="mt-3"></div>
            <h5 class="mt-4 text-purple text-center font-weight-bold">ðŸ“Œ Timeline Milestones</h5>
            <div id="milestoneTimeline" class="mt-3 ml-2 border-left border-purple pl-3"></div>
          </div>
        </div>

      </div>
    </section>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3/dist/js/adminlte.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Sidebar toggle for mobile
  const sidebar = document.querySelector('.main-sidebar');
  const toggleBtn = document.getElementById('sidebarToggle');
  const backdrop = document.querySelector('.sidebar-backdrop');
  toggleBtn.onclick = function() {
    sidebar.classList.toggle('active');
    backdrop.classList.toggle('active');
  };
  backdrop.onclick = function() {
    sidebar.classList.remove('active');
    backdrop.classList.remove('active');
  };

  const TOWNS_GEOJSON = 'towns.geojson';
  const GRID_GEOJSON = 'grid.geojson';
  const SHEET_API = 'https://script.google.com/macros/s/AKfycbzigzh2j9yMyi_CbqFXMZLeWkCsqqerRPc9sxoAFJCnVRDyf37Og-IuuYmdlN1XTny6zA/exec';

  let villageLayer, gridLayer, townsDataGlobal, gridDataGlobal, sheetData = [];

  async function init() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const [townsData, gridData, sheetResp] = await Promise.all([
      fetch(TOWNS_GEOJSON).then(r => r.json()),
      fetch(GRID_GEOJSON).then(r => r.json()),
      fetch(SHEET_API).then(r => r.json())
    ]);

    townsDataGlobal = townsData;
    gridDataGlobal = gridData;
    sheetData = sheetResp;

    document.getElementById('loadingOverlay').style.display = 'none';

    const map = L.map('map').setView([22.3, 71.7], 7);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: 'Â© OSM'
    }).addTo(map);

    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
    });

    const terrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
      maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
    });

    L.control.layers({ OpenStreetMap: osm, Satellite: satellite, Terrain: terrain }).addTo(map);

    const select = $('#townSelect');
    const allTowns = [...new Set(townsData.features.map(f => f.properties.Town).concat(sheetData.map(s => s.Town)))];
    allTowns.filter(Boolean).forEach(t => select.append(`<option>${t}</option>`));

    select.change(() => {
      const selected = select.val();
      if (villageLayer) map.removeLayer(villageLayer);
      if (gridLayer) map.removeLayer(gridLayer);
      $('#villageDetails').empty();
      $('#sheetDetails').empty();
      $('#milestoneTimeline').empty();

      if (!selected) {
        $('#sideTownTitle').fadeOut();
        return;
      }

      $('#sideTownTitle').text(`Details for Town: ${selected}`).fadeIn();

      const feature = townsData.features.find(f => f.properties.Town === selected);
      if (feature) {
        villageLayer = L.geoJSON(feature, {
          style: { color: '#007bff', weight: 2, fillOpacity: 0 }
        }).addTo(map);
        map.fitBounds(villageLayer.getBounds());

        const fieldOrder = ['DISTRICT', 'TEHSIL', 'ZONE', 'Type', 'KML_SHP_Ar', 'Sheets_2k_', 'No_of_2k_s'];
        const props = feature.properties;
        let tableHTML = '<table id="villageAttributes"><tbody>';
        fieldOrder.forEach(key => {
          tableHTML += `<tr><th>${key}</th><td>${props[key] ?? '-'}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        $('#villageDetails').html(tableHTML);
      }

      const gridFeatures = gridDataGlobal.features.filter(f => f.properties.Town === selected);
      if (gridFeatures.length > 0) {
        gridLayer = L.geoJSON({ type: 'FeatureCollection', features: gridFeatures }, {
          style: { color: 'yellow', weight: 1, fillOpacity: 0 }
        }).addTo(map);
      }

      const townRows = sheetData.filter(row => row.Town === selected);
      if (townRows.length > 0) {
        const row = townRows[0];
        let html = '<table class="table table-bordered"><tbody>';
        Object.entries(row).forEach(([key, value]) => {
          html += `<tr><th>${key}</th><td>${value}</td></tr>`;
        });
        html += '</tbody></table>';
        $('#sheetDetails').html(html);

        if (row.Milestones) {
          const milestones = row.Milestones.split(',').map(m => m.trim());
          let timelineHTML = '';
          milestones.forEach((milestone, i) => {
            timelineHTML += `
              <div class="position-relative mb-3 pl-3">
                <div class="position-absolute rounded-circle bg-purple" style="width: 12px; height: 12px; left: -6px; top: 6px;"></div>
                <div class="bg-light border rounded p-2 shadow-sm">
                  <div class="font-weight-bold text-purple">Milestone ${i + 1}</div>
                  <div>${milestone}</div>
                </div>
              </div>`;
          });
          $('#milestoneTimeline').html(timelineHTML);
        } else {
          $('#milestoneTimeline').html('<div class="text-muted">No milestones available for this town.</div>');
        }
      }
    });
  }

  init();
</script>
</body>
</html>
