<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Town Dashboard - GDD GD</title>

  <!-- AdminLTE & FontAwesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    #map { height: 500px; width: 100%; }
    #villageAttributes { width: 100%; border-collapse: collapse; }
    #villageAttributes th, #villageAttributes td { border: 1px solid #ccc; padding: 5px; }
    #villageAttributes th { background-color: #f0f0f0; width: 40%; }
    .row-flex { display: flex; flex-wrap: wrap; gap: 20px; }
    .col-map { flex: 2 1 60%; min-width: 300px; }
    .col-table { flex: 1 1 35%; min-width: 250px; }
    @media (max-width: 768px) { .row-flex { flex-direction: column; } }

    .top-navbar-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1050;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      background: #fff;
    }
    @media (max-width: 767.98px) {
      body, .content-wrapper {
        padding-top: 55px !important;
      }
      .main-header .navbar-nav .nav-item img {
        height: 32px !important;
        margin-right: 6px !important;
      }
      .main-header .navbar-nav .nav-item div span {
        font-size: 0.95rem !important;
      }
    }
    @media (min-width: 768px) {
      body, .content-wrapper {
        padding-top: 65px !important;
      }
    }
    /* Hide sidebar on mobile, show toggle button */
    @media (max-width: 991.98px) {
      .main-sidebar {
        left: -250px;
        transition: left 0.3s;
      }
      .main-sidebar.active {
        left: 0;
      }
      #sidebarToggle {
        display: block !important;
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 3000;           /* Highest z-index to stay on top */
        width: 56px;             /* Larger clickable area */
        height: 56px;
        padding: 0;
        background: transparent;  /* Transparent background */
        border: none;
        box-shadow: none;
        color: #007bff;
        border-radius: 50%;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #sidebarToggle i {
        font-size: 2rem;
        pointer-events: none;    /* Ensures the button itself gets the click */
      }
      .sidebar-backdrop {
        display: none;
        position: fixed;
        z-index: 1049;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.3);
      }
      .sidebar-backdrop.active {
        display: block;
      }
    }
    @media (min-width: 992px) {
      #sidebarToggle, .sidebar-backdrop {
        display: none !important;
      }
    }
    .main-sidebar {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    .main-sidebar .brand-link {
      position: sticky;
      top: 0;
      z-index: 1100;
      margin-top: 0 !important;
      padding-top: 0.5rem !important;
      padding-bottom: 0.5rem !important;
      height: 65px !important;
      min-height: 65px !important;
      box-sizing: border-box;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
  <div class="sidebar-backdrop"></div>
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(255,255,255,0.8);display:flex;align-items:center;justify-content:center;">
    <div>
      <i class="fas fa-spinner fa-spin fa-3x" style="color:#007bff;"></i>
      <div style="margin-top:10px;text-align:center;color:#007bff;font-weight:bold;">Loading...</div>
    </div>
  </div>
  <div class="wrapper">

    <!-- Navbar (same as index.html) -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light top-navbar-fixed">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button" id="sidebarToggle2"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-flex align-items-center">
          <img src="soi.png" alt="Logo" style="height:32px;width:auto;margin-right:8px;">
          <div style="display:flex; flex-direction:column; line-height:1;">
            <span style="font-weight:bold; font-size:1rem; color:#0056b3; letter-spacing:1px; text-transform:uppercase;">
              GUJARAT DAMAN &amp; DIU GD
            </span>
            <span style="font-size:0.92rem; color:#e85a8b; font-weight:bold; margin-top:2px;">
              AMRUT 2.0
            </span>
          </div>
        </li>
      </ul>
      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <img src="amrut-logo.png" alt="Top Logo" style="height: 40px; width: auto;">
        </li>
      </ul>
    </nav>

    <!-- Sidebar (with indented Select Town submenu) -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo: Only SOI logo, same size as in top navbar, not resized -->
      <a href="index.html" class="brand-link" style="justify-content:center; background:#0056b3;">
        <img src="soi.png" alt="Logo" style="opacity:.8; height:32px; width:auto; margin:auto; display:block;">
      </a>
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
            <li class="nav-item">
              <a href="index.html" class="nav-link">
                <i class="nav-icon fas fa-home"></i>
                <p>Home</p>
              </a>
            </li>
            <li class="nav-item has-treeview menu-open">
              <a href="#" class="nav-link active">
                <i class="nav-icon fas fa-map-marker-alt"></i>
                <p>
                  Town
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview" style="display:block;">
                <li class="nav-item">
                  <a href="#" class="nav-link" style="padding-left: 2.5rem;">
                    <p style="margin-bottom:0;">
                      <select id="townSelect" class="form-control form-control-sm" style="margin-top:0; width: 140px;">
                        <option value="">-- Select Town --</option>
                      </select>
                    </p>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </nav>
        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->
    </aside>

    <!-- Content (reduce gap above map) -->
    <div class="content-wrapper p-2" style="padding-top: 70px !important;">
      <section class="content">
        <div class="container-fluid">

          <div class="row-flex" style="margin-top:-12px;">
            <div class="col-map">
              <div id="map"></div>
            </div>
            <div class="col-table" style="height: 100%;">
              <div id="sideTownTitle" style="text-align: center; background-color: #f3e5f5; padding: 8px; font-weight: bold; color: #6a1b9a; display: none;"></div>
              <div id="villageDetails"></div>
              <div id="sheetDetails" class="mt-3" style="height:calc(100% - 60px);overflow-y:auto; margin-top:0;"></div>
              <h5 class="mt-4 text-purple text-center font-weight-bold">ðŸ“Œ Timeline Milestones</h5>
              <div id="milestoneTimeline" class="mt-3 ml-2 border-left border-purple pl-3"></div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3/dist/js/adminlte.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Sidebar toggle for mobile
    const sidebar = document.querySelector('.main-sidebar');
    const toggleBtn2 = document.getElementById('sidebarToggle2');
    const backdrop = document.querySelector('.sidebar-backdrop');
    toggleBtn2.onclick = function(e) {
      e.preventDefault();
      sidebar.classList.toggle('active');
      backdrop.classList.toggle('active');
    };
    backdrop.onclick = function() {
      sidebar.classList.remove('active');
      backdrop.classList.remove('active');
    };
    document.body.addEventListener('click', function(e) {
      if (window.innerWidth <= 991 && sidebar.classList.contains('active')) {
        if (!sidebar.contains(e.target) && !toggleBtn2.contains(e.target)) {
          sidebar.classList.remove('active');
          backdrop.classList.remove('active');
        }
      }
    });

    const TOWNS_GEOJSON = 'towns.geojson';
    const GRID_GEOJSON = 'grid.geojson';
    const SHEET_API = 'https://script.google.com/macros/s/AKfycbzigzh2j9yMyi_CbqFXMZLeWkCsqqerRPc9sxoAFJCnVRDyf37Og-IuuYmdlN1XTny6zA/exec';

    let villageLayer, gridLayer, townsDataGlobal, gridDataGlobal, sheetData = [];

    async function init() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      const [townsData, gridData, sheetResp] = await Promise.all([
        fetch(TOWNS_GEOJSON).then(r => r.json()),
        fetch(GRID_GEOJSON).then(r => r.json()),
        fetch(SHEET_API).then(r => r.json())
      ]);

      townsDataGlobal = townsData;
      gridDataGlobal = gridData;
      sheetData = sheetResp;

      document.getElementById('loadingOverlay').style.display = 'none';

      // --- Make satellite the default layer ---
      const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
      });
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18, attribution: 'Â© OSM'
      });
      const terrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3']
      });

      // --- Make layer control icon small ---
      const map = L.map('map', {
        layers: [satellite] // Satellite as default
      }).setView([22.3, 71.7], 7);

      // Custom small icon for layer control
      setTimeout(() => {
        const layerControl = document.querySelector('.leaflet-control-layers-toggle');
        if (layerControl) {
          layerControl.style.width = '26px';
          layerControl.style.height = '26px';
          layerControl.style.backgroundSize = '20px 20px';
        }
      }, 500);

      L.control.layers(
        { Satellite: satellite, OpenStreetMap: osm, Terrain: terrain }
      ).addTo(map);

      const select = $('#townSelect');
      const allTowns = [...new Set(townsData.features.map(f => f.properties.Town).concat(sheetData.map(s => s.Town)))];
      allTowns.filter(Boolean).forEach(t => select.append(`<option>${t}</option>`));

      select.change(() => {
        const selected = select.val();
        if (villageLayer) map.removeLayer(villageLayer);
        if (gridLayer) map.removeLayer(gridLayer);
        $('#villageDetails').empty();
        $('#sheetDetails').empty();
        $('#milestoneTimeline').empty();

        if (!selected) {
          $('#sideTownTitle').fadeOut();
          return;
        }

        $('#sideTownTitle').text(selected).fadeIn();

        // Elegant Table with selected fields, no header, table touches town name
        const townRows = sheetData.filter(row => row.Town === selected);
        if (townRows.length > 0) {
          const row = townRows[0];
          const tableFields = [
            { key: "DISTRICT", label: "District" },
            { key: "TEHSIL", label: "Tehsil" },
            { key: "Type", label: "Type" },
            { key: "KML Area", label: "KML Area" },
            { key: "Sheet 2K Area", label: "Sheet 2K Area" },
            { key: "2K Sheets", label: "2K Sheets" },
            { key: "ZONE", label: "Zone" }
          ];
          let html = `
            <table class="table table-bordered table-striped mb-0" style="background:#fff; margin-top:0;">
              <tbody>
          `;
          tableFields.forEach(f => {
            html += `<tr>
              <td style="font-weight:600; width:40%;">${f.label}</td>
              <td>${row[f.key] ?? '-'}</td>
            </tr>`;
          });
          html += '</tbody></table>';
          $('#sheetDetails').html(html);

          // --- Elegant Timeline for all milestone fields ---
          // List the fields in the order you want them to appear in the timeline
          const timelineFields = [
            { key: "Plan received from Firm", label: "Plan received from Firm", color: "#17a2b8" },
            { key: "Plan Approved", label: "Plan Approved", color: "#28a745" },
            { key: "1st Milstone", label: "1st Milestone", color: "#ffc107" },
            { key: "2nd Milestone Target", label: "2nd Milestone Target", color: "#dc3545" }
          ];

          let timelineHTML = '<div class="timeline">';
          let hasTimeline = false;
          timelineFields.forEach((field, idx) => {
            if (row[field.key]) {
              hasTimeline = true;
              timelineHTML += `
                <div class="timeline-item">
                  <div class="timeline-marker" style="background:${field.color};border-color:${field.color};"></div>
                  <div class="timeline-content">
                    <div class="timeline-title font-weight-bold mb-1" style="color:${field.color};">${field.label}</div>
                    <div class="timeline-date text-muted" style="font-size:0.95rem;">${row[field.key]}</div>
                  </div>
                </div>
              `;
            }
          });
          timelineHTML += '</div>';
          if (!hasTimeline) {
            timelineHTML = '<div class="text-muted">No timeline data available for this town.</div>';
          }
          $('#milestoneTimeline').html(timelineHTML);

          // Add some simple timeline CSS if not present
          if (!document.getElementById('timeline-css')) {
            const style = document.createElement('style');
            style.id = 'timeline-css';
            style.innerHTML = `
              .timeline { position: relative; margin-left: 20px; }
              .timeline-item { display: flex; align-items: flex-start; margin-bottom: 24px; }
              .timeline-marker {
                width: 14px; height: 14px; border-radius: 50%;
                margin-right: 16px; margin-top: 2px;
                border: 2px solid #17a2b8; background: #fff;
                box-shadow: 0 0 0 2px #e3f7fa;
                flex-shrink: 0;
              }
              .timeline-content { flex: 1; }
              .timeline-title { font-size: 1rem; }
              .timeline-date { font-size: 0.95rem; }
            `;
            document.head.appendChild(style);
          }
        } else {
          $('#sheetDetails').html('<div class="text-muted">No data available for this town.</div>');
          $('#milestoneTimeline').html('<div class="text-muted">No timeline data available for this town.</div>');
        }

        // Keep: Highlight town boundary on map if desired
        const feature = townsData.features.find(f => f.properties.Town === selected);
        if (feature) {
          villageLayer = L.geoJSON(feature, {
            style: { color: '#007bff', weight: 2, fillOpacity: 0 }
          }).addTo(map);
          map.fitBounds(villageLayer.getBounds());
        }

        // Keep: Show grid if available
        const gridFeatures = gridDataGlobal.features.filter(f => f.properties.Town === selected);
        if (gridFeatures.length > 0) {
          gridLayer = L.geoJSON({ type: 'FeatureCollection', features: gridFeatures }, {
            style: { color: 'yellow', weight: 1, fillOpacity: 0 }
          }).addTo(map);
        }
      });
    }

    init();
  </script>
</body>
</html>
